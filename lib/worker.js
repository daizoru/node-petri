// Generated by CoffeeScript 1.6.3
(function() {
  var P, cluster, colors, every, makeId, mutable, mutate, pick, pretty, sha1, _ref, _ref1;

  cluster = require('cluster');

  colors = require('colors');

  _ref = require('evolve'), mutable = _ref.mutable, mutate = _ref.mutate;

  _ref1 = require('./common'), P = _ref1.P, makeId = _ref1.makeId, sha1 = _ref1.sha1, pick = _ref1.pick, every = _ref1.every, pretty = _ref1.pretty;

  module.exports = function() {
    var agent, emit, onEvent, spawned;
    agent = {
      sha: '',
      name: '',
      listeners: {}
    };
    emit = function(msg) {
      return process.send(JSON.stringify(msg));
    };
    onEvent = function(signalKey, cb) {
      var _ref2;
      return listeners[signalKey] = ((_ref2 = listeners[signalKey]) != null ? _ref2 : []).push(cb);
    };
    spawned = false;
    process.on('message', function(raw) {
      var context, listener, msg, _i, _len, _ref2, _ref3, _results;
      msg = JSON.parse(raw);
      switch (msg.cmd) {
        case 'spawn':
          console.log("worker: spawning");
          agent.sha = sha1(msg.src);
          agent.src = msg.src;
          agent.name = ("" + agent.sha).slice(-8);
          context = {};
          context.emit = emit;
          context.logger = {
            failure: function(msg) {
              return context.emit({
                cmd: 'log',
                level: 0,
                msg: ("" + msg).red
              });
            },
            warn: function(msg) {
              return context.emit({
                cmd: 'log',
                level: 1,
                msg: ("" + msg).yellow
              });
            },
            success: function(msg) {
              return context.emit({
                cmd: 'log',
                level: 2,
                msg: ("" + msg).green
              });
            },
            info: function(msg) {
              return context.emit({
                cmd: 'log',
                level: 2,
                msg: "" + msg
              });
            },
            debug: function(msg) {
              return context.emit({
                cmd: 'log',
                level: 3,
                msg: ("" + msg).grey
              });
            }
          };
          every(5..sec(function() {
            return emit({
              cmd: 'ping'
            });
          }));
          eval("var Agent = " + msg.src + ";");
          return Agent.apply(context, [msg]);
        default:
          _ref3 = (_ref2 = agent.listeners[msg.cmd]) != null ? _ref2 : [];
          _results = [];
          for (_i = 0, _len = _ref3.length; _i < _len; _i++) {
            listener = _ref3[_i];
            _results.push(listener());
          }
          return _results;
      }
    });
    return emit({
      cmd: 'ready'
    });
  };

}).call(this);
