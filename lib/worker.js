// Generated by CoffeeScript 1.6.3
(function() {
  var P, cluster, colors, every, log, makeId, mutable, mutate, pick, pretty, sha1, _ref, _ref1;

  cluster = require('cluster');

  colors = require('colors');

  _ref = require('evolve'), mutable = _ref.mutable, mutate = _ref.mutate;

  _ref1 = require('./common'), P = _ref1.P, makeId = _ref1.makeId, sha1 = _ref1.sha1, pick = _ref1.pick, every = _ref1.every, pretty = _ref1.pretty, log = _ref1.log;

  module.exports = function() {
    var agent, emit, onEvent, spawned;
    agent = {
      sha: '',
      name: '',
      listeners: {}
    };
    emit = function(msg) {
      return process.send(JSON.stringify(msg));
    };
    onEvent = function(signalKey, cb) {
      var _ref2;
      return listeners[signalKey] = ((_ref2 = listeners[signalKey]) != null ? _ref2 : []).push(cb);
    };
    spawned = false;
    process.on('message', function(raw) {
      var context, err, k, listener, loaded, msg, v, _i, _len, _ref2, _ref3, _ref4, _results;
      msg = JSON.parse(raw);
      switch (msg.cmd) {
        case 'die':
          emit({
            cmd: 'warn',
            msg: 'master asked me to die'
          });
          return process.exit(-1);
        case 'spawn':
          _ref2 = msg.agent;
          for (k in _ref2) {
            v = _ref2[k];
            if (k === 'listeners') {
              continue;
            }
            agent[k] = v;
          }
          if (!agent.src) {
            emit({
              cms: 'failure',
              msg: "no src found in params passed ot the spawn()"
            });
            process.exit(-1);
          }
          try {
            loaded = require(agent.src);
            if (loaded) {
              agent.src = loaded.toString();
            } else {
              log("loaded a module, but it is empty");
            }
          } catch (_error) {
            err = _error;
            log("this is not a module");
          }
          context = {
            emit: emit,
            src: agent.src,
            logger: {
              failure: function(msg) {
                return emit({
                  cmd: 'failure',
                  msg: msg.toString()
                });
              },
              warn: function(msg) {
                return emit({
                  cmd: 'warn',
                  msg: msg.toString()
                });
              },
              success: function(msg) {
                return emit({
                  cmd: 'success',
                  msg: msg.toString()
                });
              },
              info: function(msg) {
                return emit({
                  cmd: 'info',
                  msg: msg.toString()
                });
              },
              debug: function(msg) {
                return emit({
                  cmd: 'debug',
                  msg: msg.toString()
                });
              }
            }
          };
          every(3..sec(function() {
            return emit({
              cmd: 'ping'
            });
          }));
          eval("var Agent = " + agent.src + ";");
          console.log("spawned " + (pretty(agent.name)));
          return Agent.apply(context, [msg.params]);
        default:
          _ref4 = (_ref3 = agent.listeners[msg.cmd]) != null ? _ref3 : [];
          _results = [];
          for (_i = 0, _len = _ref4.length; _i < _len; _i++) {
            listener = _ref4[_i];
            _results.push(listener());
          }
          return _results;
      }
    });
    return emit({
      cmd: 'ready'
    });
  };

}).call(this);
