// Generated by CoffeeScript 1.4.0
(function() {
  var P, agent, cluster, deck, inspect, makeId, map, mutable, mutate, pick, pretty, repeat, sha1, timmy, wait, _ref, _ref1, _ref2;

  cluster = require('cluster');

  inspect = require('util').inspect;

  deck = require('deck');

  _ref = require('ragtime'), map = _ref.map, wait = _ref.wait, repeat = _ref.repeat;

  _ref1 = require('evolve'), mutable = _ref1.mutable, mutate = _ref1.mutate;

  timmy = require('timmy');

  _ref2 = require('./common'), P = _ref2.P, makeId = _ref2.makeId, sha1 = _ref2.sha1, pick = _ref2.pick, pretty = _ref2.pretty;

  agent = void 0;

  module.exports = function(options) {
    var agentConfigurator, log, logLevel, send, _ref3;
    if (options == null) {
      options = {};
    }
    agentConfigurator = options.config;
    logLevel = (_ref3 = options.logLevel) != null ? _ref3 : 0;
    log = function(msg) {
      return console.log("(WORKER " + process.pid + ") " + msg);
    };
    log("STARTED");
    send = function(msg) {
      return process.send(JSON.stringify(msg));
    };
    process.on('message', function(msg) {
      var agentMeta, agentName, config, master;
      agentMeta = JSON.parse(msg);
      agentName = ("" + agentMeta.id).slice(0, 3) + ".." + ("" + agentMeta.id).slice(-3);
      master = {
        send: function(msg) {
          var level, logmsg, src, _ref4, _ref5;
          if ('log' in msg) {
            level = (_ref4 = msg.log.level) != null ? _ref4 : 0;
            logmsg = (_ref5 = msg.log.msg) != null ? _ref5 : '';
            if (logLevel <= level) {
              return log("(AGENT " + agentName + ") " + logmsg);
            }
          } else if ('die' in msg) {
            log("DIE");
            if (agentMeta.generation > 0) {
              return send({
                die: "end of tree"
              });
            }
          } else if ('fork' in msg) {
            src = msg.fork;
            log("FORK");
            return send({
              'fork': {
                id: makeId(),
                generation: agentMeta.generation + 1,
                hash: sha1(src),
                src: src
              }
            });
          } else {
            return send(msg);
          }
        }
      };
      master.logger = {
        alert: function(msg) {
          return master.send({
            log: {
              level: 0,
              msg: "ALERT " + msg
            }
          });
        },
        info: function(msg) {
          return master.send({
            log: {
              level: 1,
              msg: "INFO " + msg
            }
          });
        },
        debug: function(msg) {
          return master.send({
            log: {
              level: 2,
              msg: "DEBUG " + msg
            }
          });
        }
      };
      config = agentConfigurator(agentMeta);
      eval("var Agent = " + agentMeta.src + ";");
      Agent(master, agentMeta.src, config);
      return repeat(5000, function() {
        return send({
          'heartbeat': 'heartbeat'
        });
      });
    });
    send({
      'ready': 0
    });
    return {
      'on': function(key) {}
    };
  };

}).call(this);
