// Generated by CoffeeScript 1.4.0
(function() {
  var Database, P, Stats, cluster, debug, inspect, isFunction, makeId, pretty, repeat, timmy, wait, _ref, _ref1;

  inspect = require('util').inspect;

  cluster = require('cluster');

  _ref = require('ragtime'), repeat = _ref.repeat, wait = _ref.wait;

  timmy = require('timmy');

  Database = require('./database');

  Stats = require('./stats');

  _ref1 = require('./common'), P = _ref1.P, isFunction = _ref1.isFunction, makeId = _ref1.makeId;

  debug = function(msg) {
    if (true) {
      return console.log("" + msg);
    }
  };

  pretty = function(obj) {
    return "" + (inspect(obj, false, 20, true));
  };

  module.exports = function(options) {
    var agent, bootstrap, database, databaseSize, debugInterval, decimationTrigger, frequency, i, restart_delay, spawn, workersByMachine, _i, _len, _ref2, _ref3, _ref4, _ref5, _ref6, _ref7;
    if (options == null) {
      options = {};
    }
    console.log("master started with options: " + pretty(options));
    workersByMachine = (_ref2 = options.workersByMachine) != null ? _ref2 : common.NB_CORES;
    decimationTrigger = (_ref3 = options.decimationTrigger) != null ? _ref3 : 10;
    frequency = (_ref4 = options.frequency) != null ? _ref4 : 1000;
    databaseSize = (_ref5 = options.databaseSize) != null ? _ref5 : 10;
    debugInterval = (_ref6 = options.debugInterval) != null ? _ref6 : 2..sec;
    restart_delay = 500..ms;
    database = new Database(databaseSize);
    bootstrap = (_ref7 = options.bootstrap) != null ? _ref7 : [];
    console.log("loading " + bootstrap.length + " agents");
    for (_i = 0, _len = bootstrap.length; _i < _len; _i++) {
      agent = bootstrap[_i];
      database.add(agent);
    }
    spawn = function() {
      var send, worker;
      console.log("spawn");
      worker = cluster.fork();
      send = function(msg) {
        return worker.send(JSON.stringify(msg));
      };
      return worker.on('message', function(msg) {
        var _j, _len1, _ref8;
        console.log("worker replied: " + msg);
        msg = JSON.parse(msg);
        if ('ready' in msg) {
          console.log("worker said hello, sending genome");
          agent = database.next();
          if (agent != null) {
            console.log("sending agent program to worker process");
            worker.agent = agent;
            send(agent);
          } else {
            console.log("error, no more agent to send. system will shutdown.");
            _ref8 = cluster.workers;
            for (_j = 0, _len1 = _ref8.length; _j < _len1; _j++) {
              worker = _ref8[_j];
              worker.destroy();
            }
            process.exit(0);
          }
        }
        if ('fork' in msg) {
          console.log("agent want to fork");
          database.record(msg.fork);
        }
        if ('die' in msg) {
          console.log("agent want to die: " + msg.die);
          return database.remove(worker.agent);
        }
      });
    };
    cluster.on("exit", function(worker, code, signal) {
      console.log("worker exited: " + code);
      return wait(restart_delay)(function() {
        return spawn();
      });
    });
    i = 0;
    while (i++ < workersByMachine) {
      spawn();
    }
    repeat(debugInterval, function() {
      var g, genome;
      g = genome = database.pick();
      if (!g) {
        return;
      }
      console.log("random individual:");
      console.log("  hash:     : " + g.hash);
      console.log("  generation: " + g.generation);
      /*
          console.log "   parent stats:"
          console.log "    forking   : #{g.stats.forking_rate}"
          console.log "    mutation  : #{g.stats.mutation_rate}"
          console.log "    lifespan  : #{g.stats.lifespan_rate}\n"
      */

      console.log(" general stats:");
      console.log("  db size: " + (database.size()));
      return console.log("  counter: " + database.counter);
    });
    return console.log("  oldest : " + (database.oldestGeneration()) + "\n");
  };

}).call(this);
